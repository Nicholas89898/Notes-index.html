<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cloud Journal</title>
<style>
body { margin:0; font-family:sans-serif; background:#121212; color:#eee; }
#login, #app { padding:10px; display:flex; gap:6px; flex-wrap:wrap; }
input, button { background:#222; color:#eee; border:none; padding:6px; border-radius:4px; }
button { cursor:pointer; }
#tabBar { display:flex; gap:5px; padding:10px; flex-wrap:wrap; }
.tab { background:#333; padding:5px 8px; border-radius:4px; cursor:pointer; }
.tab.active { background:#007acc; }
textarea { width:95%; height:300px; background:#222; color:#eee; border:none; padding:10px; margin:10px; resize:none; }
</style>
</head>
<body>

<div id="login">
  <input id="username" placeholder="Enter username">
  <button id="loginBtn">Enter</button>
</div>

<div id="app" style="display:none;">
  <div id="tabBar"></div>
  <button onclick="addTab()">+ Tab</button>
  <button onclick="deleteTab()">Delete Tab</button>
  <button onclick="logout()">Logout</button>
  <textarea id="editor" oninput="saveEditor()"></textarea>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://nsjaqhhizizymomhkfaa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zamFxaGhpeml6eW1vbWhrZmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDUxMjMsImV4cCI6MjA4NDMyMTEyM30.Mex42yJx5xEOHfLzVNZweCnbCEmWyTPLWPziznBpeks"; // replace this
const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_KEY);

let user=null, journal={tabs:[], active:null};

// --- LOGIN ---
const usernameInput = document.getElementById("username");
const loginBtn = document.getElementById("loginBtn");
loginBtn.addEventListener("click", login);
usernameInput.addEventListener("keydown", e=>{ if(e.key==="Enter") login(); });

async function login() {
  const name = usernameInput.value.trim();
  if(!name) return;

  let { data } = await supabase.from("journals").select("*").eq("username",name).single();
  if(!data){
    // New user
    let res = await supabase.from("journals").insert({username:name,data:{tabs:["Journal"],active:"Journal"}}).select().single();
    user = res.data; journal = res.data.data;
  } else {
    user = data; journal = data.data;
  }

  document.getElementById("login").style.display="none";
  document.getElementById("app").style.display="block";
  renderTabs();
}

// --- TABS ---
function renderTabs(){
  const bar = document.getElementById("tabBar");
  bar.innerHTML="";
  journal.tabs.forEach(t=>{
    const div=document.createElement("div");
    div.className="tab"+(journal.active===t?" active":"");
    div.textContent=t;
    div.onclick=()=>openTab(t);
    bar.appendChild(div);
  });
  openTab(journal.active);
}

function openTab(name){
  if(!name) return;
  saveCurrent(); // save current editor
  journal.active=name;
  document.getElementById("editor").value = journal[name] || "";
  renderTabs();
}

function addTab(){
  const name="Tab "+(journal.tabs.length+1);
  journal.tabs.push(name);
  journal[name]="";
  journal.active=name;
  renderTabs();
  saveJournal();
}

function deleteTab(){
  if(!journal.active) return;
  const idx = journal.tabs.indexOf(journal.active);
  if(idx!==-1) journal.tabs.splice(idx,1);
  delete journal[journal.active];
  journal.active = journal.tabs[0] || null;
  document.getElementById("editor").value="";
  renderTabs();
  saveJournal();
}

// --- EDITOR ---
function saveCurrent(){
  if(journal.active){
    journal[journal.active]=document.getElementById("editor").value;
  }
}

let timeout;
function saveEditor(){
  saveCurrent();
  if(timeout) clearTimeout(timeout);
  timeout=setTimeout(saveJournal,500);
}

// --- SAVE TO SUPABASE ---
async function saveJournal(){
  await supabase.from("journals").update({data:journal}).eq("username",user.username);
}

// --- LOGOUT ---
function logout(){
  saveCurrent();
  saveJournal();
  user=null;
  journal={tabs:[],active:null};
  document.getElementById("login").style.display="flex";
  document.getElementById("app").style.display="none";
  usernameInput.value="";
  document.getElementById("editor").value="";
  document.getElementById("tabBar").innerHTML="";
}
</script>
</body>
</html>
