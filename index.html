<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cloud Journal</title>
<style>
body {
  margin:0;
  font-family: sans-serif;
  background:#111;
  color:#eee;
}
#login, #app { padding:10px; }
button { margin:3px; }
textarea {
  width:95%;
  height:300px;
  background:#222;
  color:#eee;
}
.tab { display:inline-block; padding:5px; background:#333; margin:2px; }
.tab.active { background:#555; }
</style>
</head>
<body>

<div id="login">
<h3>Login</h3>
<input id="username" placeholder="Enter username">
<button onclick="login()">Enter</button>
</div>

<div id="app" style="display:none;">
<div id="tabs"></div>
<button onclick="newTab()">+ Tab</button>
<button onclick="deleteTab()">Delete Tab</button>
<br><br>
<textarea id="editor" oninput="saveEntry()"></textarea>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://nsjaqhhizizymomhkfaa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zamFxaGhpeml6eW1vbWhrZmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDUxMjMsImV4cCI6MjA4NDMyMTEyM30.Mex42yJx5xEOHfLzVNZweCnbCEmWyTPLWPziznBpeks"; 
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentTab = null;

async function login() {
  const name = document.getElementById("username").value.trim();
  if(!name) return;

  let { data:user } = await db.from("users").select("*").eq("username",name).single();

  if(!user){
    let res = await db.from("users").insert({username:name}).select().single();
    user = res.data;
  }

  currentUser = user;
  document.getElementById("login").style.display="none";
  document.getElementById("app").style.display="block";
  loadTabs();
}

async function loadTabs(){
  const { data:tabs } = await db.from("tabs").select("*").eq("user_id",currentUser.id);
  const div = document.getElementById("tabs");
  div.innerHTML="";
  tabs.forEach(t=>{
    const b=document.createElement("div");
    b.className="tab"+(currentTab&&currentTab.id==t.id?" active":"");
    b.textContent=t.name;
    b.onclick=()=>openTab(t);
    div.appendChild(b);
  });
  if(tabs.length && !currentTab) openTab(tabs[0]);
}

async function newTab(){
  const name="Tab "+Date.now();
  await db.from("tabs").insert({user_id:currentUser.id,name});
  loadTabs();
}

async function deleteTab(){
  if(!currentTab) return;
  await db.from("entries").delete().eq("tab_id",currentTab.id);
  await db.from("tabs").delete().eq("id",currentTab.id);
  currentTab=null;
  document.getElementById("editor").value="";
  loadTabs();
}

async function openTab(tab){
  currentTab = tab;
  loadTabs();
  const { data:entry } = await db.from("entries").select("*").eq("tab_id",tab.id).single();
  document.getElementById("editor").value = entry?entry.content:"";
}

async function saveEntry(){
  if(!currentTab) return;
  const text = document.getElementById("editor").value;
  const { data:existing } = await db.from("entries").select("*").eq("tab_id",currentTab.id).single();
  if(existing){
    await db.from("entries").update({content:text}).eq("id",existing.id);
  } else {
    await db.from("entries").insert({tab_id:currentTab.id,content:text});
  }
}
</script>
</body>
</html>
