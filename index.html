<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Journal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{margin:0;font-family:sans-serif;background:#121212;color:#eee;}
header{padding:10px;background:#1f1f1f;display:flex;gap:6px;flex-wrap:wrap;}
input,button{background:#222;color:#eee;border:none;padding:6px;border-radius:4px;}
#tabBar{display:flex;gap:5px;padding:10px;background:#181818;flex-wrap:wrap;}
.tab{background:#333;padding:5px 8px;border-radius:4px;}
.tab.active{background:#007acc;}
textarea{width:100%;height:75vh;background:#222;color:#eee;border:none;padding:10px;box-sizing:border-box;}
</style>
</head>
<body>

<header id="authBar">
  <input id="email" placeholder="email">
  <input id="password" placeholder="password" type="password">
  <button onclick="login()">Login</button>
  <button onclick="register()">Register</button>
</header>

<header id="appBar" style="display:none;">
  <input id="newTabName" placeholder="New tab">
  <button onclick="addTab()">Add</button>
  <button onclick="logout()">Logout</button>
</header>

<div id="tabBar"></div>
<textarea id="editor"></textarea>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL = "https://nsjaqhhizizymomhkfaa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zamFxaGhpeml6eW1vbWhrZmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDUxMjMsImV4cCI6MjA4NDMyMTEyM30.Mex42yJx5xEOHfLzVNZweCnbCEmWyTPLWPziznBpeks";
const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_KEY);

let user = null;
let tabs=[], activeTab=null;

/* ---------- AUTH ---------- */
async function login(){
  const email = emailInput.value;
  const password = passwordInput.value;
  const { data, error } = await supabase.auth.signInWithPassword({email,password});
  if(data.user){ user=data.user; startApp(); }
}

async function register(){
  const email = emailInput.value;
  const password = passwordInput.value;
  const { data } = await supabase.auth.signUp({email,password});
  if(data.user){ user=data.user; startApp(); }
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

/* ---------- LOAD ---------- */
async function loadCloud(){
  const { data } = await supabase
    .from("journals")
    .select("data")
    .eq("user_id", user.id)
    .single();

  if(data && data.data){
    const d = data.data;
    tabs = d.tabs;
    activeTab = d.activeTab;
    tabs.forEach(t=>{
      localStorage.setItem("tab_"+t, d.content[t]||"");
    });
  }
}

/* ---------- SAVE ---------- */
async function saveCloud(){
  const payload = {tabs, activeTab, content:{}};
  tabs.forEach(t=>{
    payload.content[t]=localStorage.getItem("tab_"+t)||"";
  });

  await supabase.from("journals").upsert({
    user_id: user.id,
    data: payload,
    updated_at: new Date()
  });
}

/* ---------- UI ---------- */
function render(){
  tabBar.innerHTML="";
  tabs.forEach(t=>{
    const d=document.createElement("div");
    d.className="tab"+(t===activeTab?" active":"");
    d.textContent=t;
    d.onclick=()=>switchTab(t);
    tabBar.appendChild(d);
  });
  editor.value = activeTab ? localStorage.getItem("tab_"+activeTab)||"" : "";
}

function addTab(){
  const name=newTabName.value.trim();
  if(!name||tabs.includes(name))return;
  tabs.push(name);
  localStorage.setItem("tab_"+name,"");
  activeTab=name;
  newTabName.value="";
  render(); saveCloud();
}

function switchTab(name){
  localStorage.setItem("tab_"+activeTab, editor.value);
  activeTab=name;
  render(); saveCloud();
}

editor.addEventListener("input",()=>{
  if(activeTab){
    localStorage.setItem("tab_"+activeTab, editor.value);
    saveCloud();
  }
});

/* ---------- START ---------- */
async function startApp(){
  authBar.style.display="none";
  appBar.style.display="flex";
  await loadCloud();
  if(tabs.length===0){
    tabs=["Journal"];
    activeTab="Journal";
    localStorage.setItem("tab_Journal","");
    await saveCloud();
  }
  render();
}

/* ---------- INIT ---------- */
const emailInput=document.getElementById("email");
const passwordInput=document.getElementById("password");

supabase.auth.getUser().then(r=>{
  if(r.data.user){
    user=r.data.user;
    startApp();
  }
});
</script>

</body>
</html>
